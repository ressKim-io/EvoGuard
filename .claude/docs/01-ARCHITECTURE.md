# 시스템 아키텍처

> Content Arena 시스템 아키텍처 개요

## 전체 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                    CLIENT                                       │
│                          (Dashboard / API Consumer)                             │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              API GATEWAY (Go/Gin)                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │
│  │ Battle API  │  │ Model API   │  │ Metrics API │  │ Health / Readiness      │ │
│  │ /battles/*  │  │ /models/*   │  │ /metrics    │  │ /health, /ready         │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
          │                  │                  │
          ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           CORE SERVICES LAYER                                   │
│                                                                                 │
│  ┌──────────────────────┐  ┌──────────────────────┐  ┌────────────────────────┐│
│  │   BATTLE SERVICE     │  │   ATTACKER SERVICE   │  │   DEFENDER SERVICE     ││
│  │                      │  │                      │  │                        ││
│  │ - 라운드 관리        │  │ - 우회 패턴 생성    │  │ - 콘텐츠 분류          ││
│  │ - 결과 집계          │  │ - 전략 선택         │  │ - 탐지 판정            ││
│  │ - 트리거 발행        │  │ - LLM 호출          │  │ - 신뢰도 점수          ││
│  └──────────────────────┘  └──────────────────────┘  └────────────────────────┘│
│            │                        │                          │               │
└────────────┼────────────────────────┼──────────────────────────┼───────────────┘
             │                        │                          │
             ▼                        ▼                          ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              ML LAYER (Python)                                  │
│                                                                                 │
│  ┌──────────────────────┐  ┌──────────────────────┐  ┌────────────────────────┐│
│  │   OLLAMA SERVICE     │  │   INFERENCE SERVICE  │  │   TRAINING SERVICE     ││
│  │   (로컬 LLM)         │  │   (모델 서빙)        │  │   (QLoRA Fine-tune)    ││
│  │                      │  │                      │  │                        ││
│  │ Mistral 7B Q4        │  │ BERT / Fine-tuned    │  │ Transformers + PEFT    ││
│  │ :11434               │  │ FastAPI :8001        │  │ Background Worker      ││
│  └──────────────────────┘  └──────────────────────┘  └────────────────────────┘│
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
             │                        │                          │
             ▼                        ▼                          ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              DATA LAYER                                         │
│                                                                                 │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────────────┐  │
│  │   PostgreSQL     │  │     Redis        │  │         MLflow               │  │
│  │   (메인 DB)      │  │   (캐시/큐)      │  │   (실험 추적/모델 저장)      │  │
│  │   :5432          │  │   :6379          │  │   :5000                      │  │
│  └──────────────────┘  └──────────────────┘  └──────────────────────────────┘  │
│                                                                                 │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                        File Storage (models/, data/)                     │  │
│  │   - 학습 데이터셋                                                        │  │
│  │   - 모델 체크포인트                                                      │  │
│  │   - LoRA 어댑터                                                          │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
             │                        │                          │
             ▼                        ▼                          ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           OBSERVABILITY LAYER                                   │
│                                                                                 │
│  ┌──────────────────────┐  ┌──────────────────────┐  ┌────────────────────────┐│
│  │   Prometheus        │  │     Grafana          │  │   MLflow UI            ││
│  │   (메트릭 수집)     │  │   (대시보드)         │  │   (실험 추적)          ││
│  │   :9090             │  │   :3000              │  │   :5000                ││
│  └──────────────────────┘  └──────────────────────┘  └────────────────────────┘│
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 핵심 플로우

### 1. Battle Flow (배틀 실행 플로우)

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                           BATTLE FLOW                                        │
└──────────────────────────────────────────────────────────────────────────────┘

     Client                API Gateway          Battle Service       Attacker
        │                      │                      │                 │
        │  POST /battles       │                      │                 │
        │─────────────────────►│                      │                 │
        │                      │  CreateBattle()      │                 │
        │                      │─────────────────────►│                 │
        │                      │                      │                 │
        │                      │                      │  for each round │
        │                      │                      │─ ─ ─ ─ ─ ─ ─ ─►│
        │                      │                      │                 │
        │                      │                      │  GenerateEvasion()
        │                      │                      │◄────────────────│
        │                      │                      │                 │
     Defender             Inference Service           │                 │
        │                      │                      │                 │
        │  Classify()          │◄─────────────────────│                 │
        │◄─────────────────────│                      │                 │
        │                      │                      │                 │
        │  {toxic: 0.85}       │                      │                 │
        │─────────────────────►│  RecordResult()      │                 │
        │                      │─────────────────────►│                 │
        │                      │                      │                 │
        │                      │                      │  CheckThreshold()
        │                      │                      │─ ─ ─ ─ ─ ─ ─ ─►│
        │                      │                      │                 │
        │                      │  battle_completed    │  (이벤트 발행)  │
        │                      │◄─────────────────────│                 │
        │                      │                      │                 │
```

### 2. Auto Retrain Flow (자동 재학습 플로우)

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         AUTO RETRAIN FLOW                                    │
└──────────────────────────────────────────────────────────────────────────────┘

   Battle Service        Redis (Event)      Training Service      MLflow
        │                     │                    │                 │
        │  battle_completed   │                    │                 │
        │  evasion_rate > 30% │                    │                 │
        │────────────────────►│                    │                 │
        │                     │                    │                 │
        │                     │  TRIGGER_RETRAIN   │                 │
        │                     │───────────────────►│                 │
        │                     │                    │                 │
        │                     │                    │  CollectData()  │
        │                     │                    │─────────────────│
        │                     │                    │                 │
        │                     │                    │  StartTraining()│
        │                     │                    │─────────────────│
        │                     │                    │                 │
        │                     │                    │  QLoRA Fine-tune│
        │                     │                    │  (로컬 GPU)     │
        │                     │                    │                 │
        │                     │                    │  LogMetrics()   │
        │                     │                    │────────────────►│
        │                     │                    │                 │
        │                     │                    │  RegisterModel()│
        │                     │                    │────────────────►│
        │                     │                    │  as "challenger"│
        │                     │                    │                 │
```

### 3. Champion/Challenger Flow (모델 교체 플로우)

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                      CHAMPION/CHALLENGER FLOW                                │
└──────────────────────────────────────────────────────────────────────────────┘

  Training Service       MLflow          Evaluation Service    Inference Service
        │                  │                    │                     │
        │  model_trained   │                    │                     │
        │─────────────────►│                    │                     │
        │                  │                    │                     │
        │                  │  new_challenger    │                     │
        │                  │───────────────────►│                     │
        │                  │                    │                     │
        │                  │                    │  LoadTestSet()      │
        │                  │                    │─────────────────────│
        │                  │                    │                     │
        │                  │                    │  EvaluateChampion() │
        │                  │                    │────────────────────►│
        │                  │                    │  (현재 모델)        │
        │                  │                    │◄────────────────────│
        │                  │                    │  F1: 0.82           │
        │                  │                    │                     │
        │                  │                    │  EvaluateChallenger()
        │                  │                    │────────────────────►│
        │                  │                    │  (새 모델)          │
        │                  │                    │◄────────────────────│
        │                  │                    │  F1: 0.87           │
        │                  │                    │                     │
        │                  │                    │  if challenger > champion
        │                  │                    │                     │
        │                  │  PromoteChallenger │                     │
        │                  │◄───────────────────│                     │
        │                  │  set alias=champion│                     │
        │                  │                    │                     │
        │                  │                    │  ReloadModel()      │
        │                  │                    │────────────────────►│
        │                  │                    │  (새 champion 로드) │
        │                  │                    │                     │
```

## 컴포넌트 책임

| 컴포넌트 | 기술 | 책임 | 상세 문서 |
|----------|------|------|-----------|
| **API Gateway** | Go/Gin | HTTP 라우팅, 요청 검증, 미들웨어 | `06-API_SPEC.md` |
| **Battle Service** | Go | 배틀 라이프사이클, 결과 집계, 이벤트 발행 | `go-02-structure.md` |
| **Attacker Service** | Python/Ollama | 우회 전략 생성, LLM 변형 | `04-ML_PIPELINE.md` |
| **Defender Service** | Python/FastAPI | 콘텐츠 분류 추론, 모델 서빙 | `04-ML_PIPELINE.md` |
| **Training Service** | Python | QLoRA Fine-tuning, MLflow 추적 | `05-MLOPS.md` |



## 데이터 모델

### PostgreSQL 테이블

| 테이블 | 설명 | 주요 컬럼 |
|--------|------|-----------|
| `battles` | 배틀 상태 | id, status, config, evasion_count, detection_count |
| `battle_rounds` | 라운드 결과 | battle_id, round_number, evasion_text, toxic_score |
| `model_metadata` | 모델 정보 | mlflow_run_id, model_alias, f1_score |
| `training_data` | 학습 데이터 | text, label, source |

### Redis 키 구조

| 패턴 | 용도 |
|------|------|
| `battle:{id}:status` | 배틀 상태 캐시 |
| `metrics:detection_rate:*` | 메트릭 캐시 |
| `model:champion:*` | 모델 정보 캐시 |
| `queue:retrain_trigger` | 재학습 이벤트 큐 |
| `lock:training` | 분산 락 |

## 보안 & 확장성

**보안**: `dev-06-security.md` 참조
- API Rate Limiting, Input Validation
- 모델/데이터 접근 제어

**확장성**:
- 수평: API Gateway, Inference Service (Stateless)
- 수직: GPU 업그레이드로 학습 속도 향상
- 캐싱: 분류 결과 TTL 적용

# Deploy Workflow
# Manual deployment to Kubernetes cluster
# Triggered manually via workflow_dispatch or on release

name: Deploy

on:
  # Manual trigger with environment selection
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      service:
        description: 'Service to deploy (or "all")'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - api-service
          - ml-service
      image_tag:
        description: 'Image tag to deploy (default: latest from main)'
        required: false
        default: ''
        type: string

  # Auto-deploy on release
  release:
    types: [published]

# Only one deployment at a time per environment
concurrency:
  group: deploy-${{ github.event.inputs.environment || 'production' }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  HELM_VERSION: '3.14.0'

jobs:
  # ==========================================================================
  # Prepare
  # ==========================================================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      image_tag: ${{ steps.set-env.outputs.image_tag }}
      services: ${{ steps.set-env.outputs.services }}
    steps:
      - name: Set environment variables
        id: set-env
        run: |
          # Determine environment
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "image_tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            if [ -z "${{ github.event.inputs.image_tag }}" ]; then
              echo "image_tag=${{ github.sha }}" >> $GITHUB_OUTPUT
            else
              echo "image_tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
            fi
          fi

          # Determine services to deploy
          if [ "${{ github.event.inputs.service }}" == "all" ] || [ "${{ github.event_name }}" == "release" ]; then
            echo 'services=["api-service", "ml-service"]' >> $GITHUB_OUTPUT
          else
            echo 'services=["${{ github.event.inputs.service }}"]' >> $GITHUB_OUTPUT
          fi

      - name: Summary
        run: |
          echo "## Deployment Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ steps.set-env.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | ${{ steps.set-env.outputs.image_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Services | ${{ steps.set-env.outputs.services }} |" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # Deploy
  # ==========================================================================
  deploy:
    needs: prepare
    runs-on: ubuntu-latest
    environment: ${{ needs.prepare.outputs.environment }}
    permissions:
      contents: read
      id-token: write  # For OIDC authentication
    strategy:
      matrix:
        service: ${{ fromJson(needs.prepare.outputs.services) }}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Configure kubectl
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBECONFIG }}

      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Deploy with Helm
        run: |
          NAMESPACE="${{ needs.prepare.outputs.environment }}"
          RELEASE_NAME="${{ matrix.service }}"
          IMAGE_TAG="${{ needs.prepare.outputs.image_tag }}"

          # Create namespace if not exists
          kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

          # Deploy with Helm
          helm upgrade --install $RELEASE_NAME \
            ./k8s/helm/${{ matrix.service }} \
            --namespace $NAMESPACE \
            --set image.repository=${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.service }} \
            --set image.tag=$IMAGE_TAG \
            --set environment=${{ needs.prepare.outputs.environment }} \
            --values ./k8s/helm/${{ matrix.service }}/values-${{ needs.prepare.outputs.environment }}.yaml \
            --wait \
            --timeout 10m

      - name: Verify deployment
        run: |
          NAMESPACE="${{ needs.prepare.outputs.environment }}"
          kubectl rollout status deployment/${{ matrix.service }} -n $NAMESPACE --timeout=5m

      - name: Get deployment info
        run: |
          NAMESPACE="${{ needs.prepare.outputs.environment }}"
          echo "## Deployment Status: ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n $NAMESPACE -l app=${{ matrix.service }} >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # Post-Deploy
  # ==========================================================================
  post-deploy:
    needs: [prepare, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Overall | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Deployment failed! Check the logs for details."
          # Add notification logic here (Slack, Discord, etc.)

  # ==========================================================================
  # Rollback (separate job for safety)
  # ==========================================================================
  rollback:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && failure()
    needs: [prepare, deploy]
    environment: ${{ needs.prepare.outputs.environment }}
    steps:
      - name: Configure kubectl
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBECONFIG }}

      - name: Rollback deployments
        run: |
          NAMESPACE="${{ needs.prepare.outputs.environment }}"
          SERVICES='${{ needs.prepare.outputs.services }}'

          for service in $(echo $SERVICES | jq -r '.[]'); do
            echo "Rolling back $service..."
            kubectl rollout undo deployment/$service -n $NAMESPACE || true
          done

      - name: Rollback Summary
        run: |
          echo "## ⚠️ Rollback Executed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployment failed and rollback was attempted." >> $GITHUB_STEP_SUMMARY
